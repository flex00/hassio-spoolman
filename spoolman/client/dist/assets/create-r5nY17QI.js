import{r as d,N as le,_ as re,d as A,G as ne,T as oe,F as l,R as T,j as e,V as ue,B as j,t as de,as as he,I as O,b as me,c as fe}from"./index-DVifsFYV.js";import{WeightToEnter as n}from"./model-CZ_KvoQu.js";import{n as b,a as y}from"./parsing-BWLjJB_7.js";import{d as ce}from"./otherModels-CIUsjKAU.js";import{u as pe,E as ge}from"./queryFields-mgjQgxCo.js";import{E as _e,S as we}from"./extraFields-qtPcbZeu.js";import{u as xe}from"./utc-BBX0ZL_c.js";import{u as je,g as be}from"./settings-CgMC_ZgH.js";import{c as ye}from"./functions-CfPAYYcb.js";import{a as ve}from"./functions-D0sxzadJ.js";import{s as Ve}from"./filtering-CY1b-XQk.js";import{T as u}from"./index-Bg14sNK-.js";import{D as N}from"./inputNumberRange-BgK2w3SK.js";import{S as Q}from"./index-fxb4jQRc.js";import{A as Ie}from"./index-z7JQCk2q.js";import{R as v}from"./index-CPB1sIE8.js";import"./numberField-DPMhgxPK.js";import"./querySettings-CUjj6H0m.js";import"./functions-CK5Ek87f.js";var We={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M872 474H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h720c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"minus",theme:"outlined"},Ee=function(t,m){return d.createElement(le,re({},t,{ref:m,icon:We}))},Se=d.forwardRef(Ee);A.extend(xe);const ze=V=>{var H;const t=ne(),m=pe(ge.spool),U=je(),{form:o,formProps:r,formLoading:$,onFinish:M,redirect:z}=oe({redirect:!1,warnWhenUnsavedChanges:!1});r.initialValues||(r.initialValues={});const L=l.useWatch("initial_weight",o),k=l.useWatch("spool_weight",o);V.mode==="clone"&&(r.initialValues.first_used=null,r.initialValues.last_used=null,r.initialValues.used_weight=0,r.initialValues.filament&&(r.initialValues.filament_id=r.initialValues.filament.id));const D=new URLSearchParams(window.location.search).get("filament_id");D&&(r.initialValues.filament_id=parseInt(D));const{options:J,internalSelectOptions:g,externalSelectOptions:_,allExternalFilaments:I}=ve(),f=l.useWatch("filament_id",o),s=d.useMemo(()=>typeof f=="number"?(g==null?void 0:g.find(i=>i.value===f))??null:typeof f=="string"?(_==null?void 0:_.find(i=>i.value===f))??null:null,[f,g,_]),Y=async i=>{const a=we(await o.validateFields());if((s==null?void 0:s.is_internal)===!1){const p=I==null?void 0:I.find(ae=>ae.id===a.filament_id);if(!p)throw new Error("Unknown external filament");const R=await ye(p);a.filament_id=R.id}c>1?Array(c).fill(a).forEach(async R=>await M(R)):await M(a),z(i)};T.useEffect(()=>{var i;(i=m.data)==null||i.forEach(a=>{if(r.initialValues&&a.default_value){const p=JSON.parse(a.default_value);o.setFieldsValue({extra:{[a.key]:p}})}})},[o,m.data,r.initialValues]);const[h,W]=d.useState(1),[w,K]=d.useState(0);T.useEffect(()=>{const i=(s==null?void 0:s.weight)||0,a=(s==null?void 0:s.spool_weight)||0;i>0&&o.setFieldValue("initial_weight",i),a>0&&o.setFieldValue("spool_weight",a)},[s]);const E=i=>{K(i),o.setFieldsValue({used_weight:i})},B=ce(!0),[x,X]=d.useState(""),S=[...B.data||[]];x.trim()&&!S.includes(x)&&S.push(x.trim());const[c,F]=d.useState(1),Z=()=>{F(c+1)},ee=()=>{F(c-1)},ie=()=>k??(s==null?void 0:s.spool_weight)??0,C=()=>L??(s==null?void 0:s.weight)??0,P=()=>{const i=C(),a=ie();return i+a},te=()=>P()-w,se=()=>C()-w,G=()=>q()?!!(k||s!=null&&s.spool_weight):!1,q=()=>L?!0:!!(s!=null&&s.weight);return T.useEffect(()=>{if(h>=n.measured_weight&&!G()){W(n.remaining_weight);return}if(h>=n.remaining_weight&&!q()){W(n.used_weight);return}},[s]),e.jsx(ue,{title:V.mode==="create"?t("spool.titles.create"):t("spool.titles.clone"),isLoading:$,footerButtons:()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",backgroundColor:"#141414",border:"1px solid #424242",borderRadius:"6px"},children:[e.jsx(j,{type:"text",style:{padding:0,width:32,height:32},onClick:ee,children:e.jsx(Se,{})}),e.jsx(u,{name:"Quantity",min:1,id:"qty-input",controls:!1,value:c}),e.jsx(j,{type:"text",style:{padding:0,width:32,height:32},onClick:Z,children:e.jsx(de,{})})]}),e.jsx(j,{type:"primary",onClick:()=>Y("list"),children:t("buttons.save")}),e.jsx(j,{type:"primary",onClick:()=>Y("create"),children:t("buttons.saveAndAdd")})]}),children:e.jsxs(l,{...r,layout:"vertical",children:[e.jsx(l.Item,{label:t("spool.fields.first_used"),name:["first_used"],rules:[{required:!1}],getValueProps:i=>({value:i?A(i):void 0}),children:e.jsx(N,{showTime:!0,format:"YYYY-MM-DD HH:mm:ss"})}),e.jsx(l.Item,{label:t("spool.fields.last_used"),name:["last_used"],rules:[{required:!1}],getValueProps:i=>({value:i?A(i):void 0}),children:e.jsx(N,{showTime:!0,format:"YYYY-MM-DD HH:mm:ss"})}),e.jsx(l.Item,{label:t("spool.fields.filament"),name:["filament_id"],rules:[{required:!0}],children:e.jsx(Q,{options:J,showSearch:!0,filterOption:(i,a)=>typeof(a==null?void 0:a.label)=="string"&&Ve(i,a==null?void 0:a.label)})}),(s==null?void 0:s.is_internal)===!1&&e.jsx(Ie,{message:t("spool.fields_help.external_filament"),type:"info"}),e.jsx(l.Item,{label:t("spool.fields.price"),help:t("spool.fields_help.price"),name:["price"],rules:[{required:!1,type:"number",min:0}],children:e.jsx(u,{addonAfter:be(void 0,U),precision:2,formatter:b,parser:y})}),e.jsx(l.Item,{label:t("spool.fields.initial_weight"),help:t("spool.fields_help.initial_weight"),name:["initial_weight"],rules:[{required:!1,type:"number",min:0}],children:e.jsx(u,{addonAfter:"g",precision:1})}),e.jsx(l.Item,{label:t("spool.fields.spool_weight"),help:t("spool.fields_help.spool_weight"),name:["spool_weight"],rules:[{required:!1,type:"number",min:0}],children:e.jsx(u,{addonAfter:"g",precision:1})}),e.jsx(l.Item,{hidden:!0,name:["used_weight"],initialValue:0,children:e.jsx(u,{value:w})}),e.jsx(l.Item,{label:t("spool.fields.weight_to_use"),help:t("spool.fields_help.weight_to_use"),children:e.jsxs(v.Group,{onChange:i=>{W(i.target.value)},defaultValue:n.used_weight,value:h,children:[e.jsx(v.Button,{value:n.used_weight,children:t("spool.fields.used_weight")}),e.jsx(v.Button,{value:n.remaining_weight,disabled:!q(),children:t("spool.fields.remaining_weight")}),e.jsx(v.Button,{value:n.measured_weight,disabled:!G(),children:t("spool.fields.measured_weight")})]})}),e.jsx(l.Item,{label:t("spool.fields.used_weight"),help:t("spool.fields_help.used_weight"),initialValue:0,children:e.jsx(u,{min:0,addonAfter:"g",precision:1,formatter:b,parser:y,disabled:h!=n.used_weight,value:w,onChange:i=>{E(i??0)}})}),e.jsx(l.Item,{label:t("spool.fields.remaining_weight"),help:t("spool.fields_help.remaining_weight"),initialValue:0,children:e.jsx(u,{min:0,addonAfter:"g",precision:1,formatter:b,parser:y,disabled:h!=n.remaining_weight,value:se(),onChange:i=>{E(C()-(i??0))}})}),e.jsx(l.Item,{label:t("spool.fields.measured_weight"),help:t("spool.fields_help.measured_weight"),initialValue:0,children:e.jsx(u,{min:0,addonAfter:"g",precision:1,formatter:b,parser:y,disabled:h!=n.measured_weight,value:te(),onChange:i=>{const a=P();E(a-(i??0))}})}),e.jsx(l.Item,{label:t("spool.fields.location"),help:t("spool.fields_help.location"),name:["location"],rules:[{required:!1}],children:e.jsx(Q,{dropdownRender:i=>e.jsxs(e.Fragment,{children:[i,e.jsx(he,{style:{margin:"8px 0"}}),e.jsx(O,{placeholder:t("spool.form.new_location_prompt"),value:x,onChange:a=>X(a.target.value)})]}),loading:B.isLoading,options:S.map(i=>({label:i,value:i}))})}),e.jsx(l.Item,{label:t("spool.fields.lot_nr"),help:t("spool.fields_help.lot_nr"),name:["lot_nr"],rules:[{required:!1}],children:e.jsx(O,{maxLength:64})}),e.jsx(l.Item,{label:t("spool.fields.comment"),name:["comment"],rules:[{required:!1}],children:e.jsx(me,{maxLength:1024})}),e.jsx(fe.Title,{level:5,children:t("settings.extra_fields.tab")}),(H=m.data)==null?void 0:H.map((i,a)=>e.jsx(_e,{field:i},a))]})})};export{ze as SpoolCreate,ze as default};

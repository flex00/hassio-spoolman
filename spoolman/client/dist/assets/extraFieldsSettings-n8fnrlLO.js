import{d as S,o as Y,G as D,F as V,r as N,s as B,j as s,p as q,B as b,P as H,t as K,I as k,v as z}from"./index-DVifsFYV.js";import{u as R,a as G,b as L,F as t}from"./queryFields-mgjQgxCo.js";import{u as Q}from"./utc-BBX0ZL_c.js";import{t as U,a as W,I as P,b as X}from"./inputNumberRange-BgK2w3SK.js";import{T as Z}from"./Trans-BPjU-PT-.js";import{F as ee}from"./Table-wd-zo2jX.js";import{F as te}from"./index-C2S-v1Or.js";import{S as T}from"./index-fxb4jQRc.js";import{T as A}from"./index-Bg14sNK-.js";import"./Tree-y2nS5-dG.js";import"./index-CPB1sIE8.js";import"./Pagination-B34JRow0.js";import"./Pagination-Bkh_d_bF.js";import"./zh_CN-cwSELhhy.js";S.extend(Q);S.extend(U);S.extend(W);const ie="YYYY-MM-DD HH:mm:ss",se=(f,a)=>a?!0:f!=="key"&&f!=="field_type"&&f!=="multi_choice",le=({record:f,editing:a,dataIndex:o,children:y,form:c,...j})=>{const u=D();if(!a||!se(o,f.is_new))return s.jsx("td",{...j,style:{wordBreak:"break-word"},children:y});const d=c.getFieldValue("field_type"),x=c.getFieldValue("choices"),g=u(`settings.extra_fields.params.${o}`);let n;const r=[],m={};o==="key"?(n=s.jsx(k,{}),r.push({required:!0,min:1,max:64,pattern:/^[a-z0-9_]+$/}),r.push({validator:async(_,v)=>{if(v==="new_field")throw new Error(u("settings.extra_fields.key_not_changed"))}})):o==="field_type"?(n=s.jsx(T,{options:[{label:u(`settings.extra_fields.field_type.${t.text}`),value:t.text},{label:u(`settings.extra_fields.field_type.${t.integer}`),value:t.integer},{label:u(`settings.extra_fields.field_type.${t.integer_range}`),value:t.integer_range},{label:u(`settings.extra_fields.field_type.${t.float}`),value:t.float},{label:u(`settings.extra_fields.field_type.${t.float_range}`),value:t.float_range},{label:u(`settings.extra_fields.field_type.${t.datetime}`),value:t.datetime},{label:u(`settings.extra_fields.field_type.${t.boolean}`),value:t.boolean},{label:u(`settings.extra_fields.field_type.${t.choice}`),value:t.choice}],onChange:()=>{c.setFieldsValue({default_value:void 0})}}),r.push({required:!0})):o==="name"?(n=s.jsx(k,{}),r.push({required:!0,min:1,max:128})):o==="order"?(n=s.jsx(A,{style:{width:"60px"}}),r.push({required:!0,min:0,type:"integer"})):o==="unit"?(d===t.integer||d===t.integer_range||d===t.float||d===t.float_range?n=s.jsx(k,{style:{width:"60px"}}):n=null,r.push({required:!1,max:16})):o==="default_value"?d===t.boolean?(n=s.jsx(z,{}),m.valuePropName="checked",r.push({type:"boolean"})):d===t.text?(n=s.jsx(k,{}),r.push({type:"string"})):d===t.integer?(n=s.jsx(A,{}),r.push({type:"integer"})):d===t.float?(n=s.jsx(A,{}),r.push({type:"number"})):d===t.integer_range?(n=s.jsx(P,{precision:0}),r.push({type:"array",len:2})):d===t.float_range?(n=s.jsx(P,{precision:3}),r.push({type:"array",len:2})):d===t.datetime?n=s.jsx(X,{}):d===t.choice&&(n=s.jsx(T,{mode:c.getFieldValue("multi_choice")?"multiple":void 0,options:x.map(_=>({label:_,value:_}))}),r.push({type:c.getFieldValue("multi_choice")?"array":"string"})):o==="choices"?d===t.choice?(n=s.jsx(T,{mode:"tags",tokenSeparators:[","],open:!1}),r.push({required:!0,min:1,type:"array",validator:async(_,v)=>{const C=f.field.choices||[],I=v||[],w=C.filter($=>!I.includes($));if(w.length>0)throw new Error(u("settings.extra_fields.choices_missing_error",{choices:w.join(", ")}))}})):n=null:o==="multi_choice"&&d===t.choice?(n=s.jsx(z,{onChange:()=>{c.setFieldsValue({default_value:void 0})},children:g}),m.valuePropName="checked",r.push({type:"boolean"})):n=null;const h=n?s.jsx(V.Item,{name:o,messageVariables:{label:g},style:{margin:0},rules:r,...m,children:n}):null;return s.jsx("td",{...j,children:h})};function ve(){const{entityType:f}=Y(),a=D(),[o]=V.useForm(),y=R(f),c=G(f),j=L(f),[u,d]=N.useState(!1),[x,g]=N.useState(null),[n,r]=B.useMessage(),[m,h]=N.useState(""),_=l=>l.field.key===m,v=l=>{const i={...l};if(i.default_value&&typeof i.default_value=="string"){const e=JSON.parse(i.default_value);i.field_type===t.boolean?i.default_value=!!e:i.default_value=e}else i.default_value=void 0;o.setFieldsValue(i),h(l.key)},C=()=>{h(""),g(null)},I=async l=>{try{await j.mutateAsync(l.key)}catch(i){i instanceof Error&&n.error(i.message)}},w=()=>{var e;const l=Math.max(...((e=y.data)==null?void 0:e.map(F=>F.order))||[],0)+1,i={key:"new_field",name:"",entity_type:f,field_type:t.text,unit:"",order:l,default_value:"",choices:[],multi_choice:!1};g({key:"new_field",field:i,is_new:!0}),o.setFieldsValue(i),h("new_field")},$=async l=>{var F;let i;try{i=await o.validateFields()}catch{return}const e={...l.field,...i};try{if((e.field_type===t.float_range||e.field_type===t.integer_range)&&e.default_value!==void 0)if(Array.isArray(e.default_value)){const p=e.default_value[0],E=e.default_value[1];e.default_value=JSON.stringify([p,E])}else console.warn("Invalid default_value for range",e.default_value);else e.default_value=JSON.stringify(e.default_value);e.field_type===t.choice&&e.multi_choice===void 0&&(e.multi_choice=!1),e.field_type!==t.choice&&(e.choices=void 0,e.multi_choice=void 0),e.unit===""&&(e.unit=void 0)}catch(p){p instanceof Error&&n.error(a("notifications.validationError",{error:p.message}));return}if(l.is_new&&new Set(((F=y.data)==null?void 0:F.map(E=>E.key))||[]).has(e.key)){n.error(a("settings.extra_fields.non_unique_key_error"));return}try{d(!0),c.reset(),await c.mutateAsync({key:e.key,params:e}),h(""),g(null)}catch(p){p instanceof Error&&n.error(p.message)}d(!1)},M=a(`${f}.${f}`),O=[{title:a("settings.extra_fields.params.key"),dataIndex:["field","key"],key:"key",width:"10%"},{title:a("settings.extra_fields.params.order"),dataIndex:["field","order"],key:"order",width:"3%"},{title:a("settings.extra_fields.params.name"),dataIndex:["field","name"]},{title:a("settings.extra_fields.params.field_type"),dataIndex:["field","field_type"],render(l){return a(`settings.extra_fields.field_type.${l}`)},width:"15%"},{title:a("settings.extra_fields.params.unit"),dataIndex:["field","unit"],width:"6%"},{title:a("settings.extra_fields.params.default_value"),dataIndex:["field","default_value"],render(l,i){const e=JSON.parse(l||"null");return typeof e=="boolean"?a(e?"settings.extra_fields.boolean_true":"settings.extra_fields.boolean_false"):typeof e=="string"&&i.field.field_type===t.datetime?S(e).format(ie):typeof e=="number"||typeof e=="string"?e:Array.isArray(e)&&i.field.field_type===t.choice?e.join(", "):Array.isArray(e)&&i.field.field_type===t.integer_range||i.field.field_type===t.float_range?`${e[0]} â€“ ${e[1]}`:null},width:"15%"},{title:a("settings.extra_fields.params.choices"),dataIndex:["field","choices"],render(l,i){return i.field.field_type===t.choice&&Array.isArray(l)?l.join(", "):null},width:"15%"},{title:a("settings.extra_fields.params.multi_choice"),dataIndex:["field","multi_choice"],render(l,i){return i.field.field_type===t.choice?a(l?"settings.extra_fields.boolean_true":"settings.extra_fields.boolean_false"):null},width:"10%"},{title:"",dataIndex:"operation",render:(l,i)=>_(i)?s.jsxs(q,{children:[s.jsx(b,{onClick:()=>$(i),size:"small",type:"primary",children:a("buttons.save")}),s.jsx(b,{onClick:()=>C(),size:"small",children:a("buttons.cancel")})]}):s.jsx(s.Fragment,{children:s.jsxs(q,{children:[s.jsx(b,{disabled:m!=="",onClick:()=>v(i.field),size:"small",children:a("buttons.edit")}),s.jsx(H,{title:a("settings.extra_fields.delete_confirm",{name:i.field.name}),description:a("settings.extra_fields.delete_confirm_description",{name:i.field.name}),onConfirm:()=>I(i.field),disabled:m!=="",okText:a("buttons.delete"),cancelText:a("buttons.cancel"),children:s.jsx(b,{disabled:m!=="",danger:!0,size:"small",children:a("buttons.delete")})})]})}),width:"10%"}].map(l=>l.dataIndex==="operation"?l:{...l,onCell:function(i){var e;return{record:i,editing:_(i),dataIndex:(((e=l.dataIndex)==null?void 0:e.toString())||"").split(",").pop()||"",form:o,children:[]}}}),J=[...(y.data||[]).sort((l,i)=>l.order-i.order).map(l=>({key:l.key,field:l,is_new:!1})),...x?[x]:[]];return s.jsxs(s.Fragment,{children:[s.jsxs("h3",{children:[a("settings.extra_fields.tab")," - ",M]}),s.jsx(Z,{i18nKey:"settings.extra_fields.description",components:{p:s.jsx("p",{})}}),s.jsx(V,{form:o,component:!1,disabled:u,children:s.jsx(ee,{components:{body:{cell:le}},columns:O,dataSource:J,loading:y.isLoading,rowClassName:"editable-row",pagination:!1})}),x==null&&s.jsx(te,{justify:"center",children:s.jsx(b,{type:"primary",shape:"circle",icon:s.jsx(K,{}),size:"large",style:{margin:"1em"},onClick:()=>w()})}),r]})}export{ve as ExtraFieldsSettings};
